<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel de Cocina - Menunet</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background-color: #22c55e;
      color: white;
      padding: 12px 20px;
      border-radius: 0.75rem;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
      animation: fadeInOut 3s ease-in-out forwards;
      font-weight: 600;
      z-index: 50;
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(20px); }
    }
  </style>
</head>

<body class="bg-gray-950 text-white font-sans min-h-screen flex flex-col">

  <!-- Barra lateral escritorio -->
  <aside class="w-64 bg-gray-900 hidden md:flex flex-col p-4">
    <h1 class="text-2xl font-bold mb-6">Menunet</h1>
    <nav class="flex flex-col gap-4 text-gray-300">
        <a href="index.html" class="hover:text-white">🏠 Dashboard</a>
        <a href="pedidos.html" class="hover:text-white">📋 Pedidos</a>
        <a href="menu.html" class="hover:text-white">🍽️ Menú</a>
        <a href="reportes.html" class="hover:text-white">📈 Reportes</a>
        <a href="configuracion.html" class="hover:text-white">⚙️ Configuración</a>
        <a href="admin.html" class="hover:text-white">🧑‍💼 Admin</a>
    </nav>
  </aside>

  <!-- Encabezado -->
  <header class="p-4 border-b border-gray-800 flex justify-between items-center">
    <h1 class="text-xl font-semibold">🍽️ Panel de Cocina</h1>
    <span class="text-sm text-gray-400">Menunet</span>
  </header>

  <!-- Filtro -->
  <div class="p-4">
    <label for="filtroEstado" class="text-gray-400 mr-2">Filtrar por estado:</label>
    <select id="filtroEstado" class="bg-gray-800 text-white p-2 rounded">
      <option value="todos">Todos</option>
      <option value="pendiente">Pendientes</option>
      <option value="listo">Listos</option>
    </select>
  </div>

  <!-- Contenido -->
  <section class="flex-1 overflow-y-auto p-4" id="pedidos-container">
    <p class="text-gray-500">Cargando pedidos...</p>
  </section>

  <!-- Toast dinámico -->
  <div id="toast-container"></div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // Configuración Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAumkx4CKgbJcdDcQ9eXzw8Ol5od8WMa5k",
      authDomain: "menunet-46d2c.firebaseapp.com",
      databaseURL: "https://menunet-46d2c-default-rtdb.firebaseio.com",
      projectId: "menunet-46d2c",
      storageBucket: "menunet-46d2c.appspot.com",
      messagingSenderId: "27587490373",
      appId: "1:27587490373:web:34b2afbb1ea3a341fa292c",
      measurementId: "G-6N4ZSXGZ56"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const pedidosContainer = document.getElementById("pedidos-container");
    const filtroEstado = document.getElementById("filtroEstado");

    // Función toast
    function showToast(message, color = "#22c55e") {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.style.backgroundColor = color;
      toast.innerText = message;
      document.getElementById("toast-container").appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    let allPedidos = {};

    // Escuchar cambios en pedidos
    db.ref("pedidos").on("value", (snapshot) => {
      allPedidos = snapshot.val() || {};
      renderPedidos();
    });

    filtroEstado.addEventListener("change", renderPedidos);

    function renderPedidos() {
      pedidosContainer.innerHTML = "";
      const estadoFiltro = filtroEstado.value;

      const pedidos = Object.entries(allPedidos || {})
        .filter(([id, p]) => p.estado !== "entregado")
        .filter(([id, p]) => {
          if (estadoFiltro === "pendiente") return !p.estado;
          if (estadoFiltro === "listo") return p.estado === "listo";
          return true;
        })
        .reverse();

      if (pedidos.length === 0) {
        pedidosContainer.innerHTML = "<p class='text-gray-500'>No hay pedidos para mostrar.</p>";
        return;
      }

      pedidos.forEach(([id, pedido]) => {
        const productosHTML = Array.isArray(pedido.productos)
          ? pedido.productos.map(p => `<li>${p.nombre} - $${p.precio.toLocaleString()}</li>`).join("")
          : "<li class='text-red-500'>Error al cargar productos</li>";

        const hora = new Date(pedido.timestamp || Date.now()).toLocaleTimeString([], {
          hour: "2-digit", minute: "2-digit"
        });

        const card = document.createElement("div");
        card.className = "bg-gray-800 rounded-xl p-4 mb-4 shadow-md";

        card.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold">🪑 Mesa ${pedido.mesa}</h2>
            <span class="text-sm text-gray-400">${hora}</span>
          </div>
          <ul class="text-sm mb-3 list-disc list-inside text-gray-300">
            ${productosHTML}
          </ul>
          <div class="flex justify-between items-center text-sm text-gray-400 mb-2">
            <span>Total:</span>
            <strong class="text-white">$${pedido.total?.toLocaleString() || "0"}</strong>
          </div>
          <div class="flex gap-2">
            <button onclick="marcarEstado('${id}', 'listo')" class="bg-yellow-500 hover:bg-yellow-400 text-black px-4 py-2 rounded-xl text-sm font-semibold">
              ✅ Listo
            </button>
            <button onclick="marcarEstado('${id}', 'entregado')" class="bg-green-500 hover:bg-green-400 text-black px-4 py-2 rounded-xl text-sm font-semibold">
              📦 Entregado
            </button>
          </div>
        `;
        pedidosContainer.appendChild(card);
      });
    }

    function marcarEstado(id, estado) {
      db.ref("pedidos/" + id).update({ estado })
        .then(() => {
          const mensaje = estado === "entregado" ? "Pedido entregado 🎉" : "Pedido marcado como listo 🍽️";
          showToast(mensaje, estado === "entregado" ? "#10b981" : "#facc15");
        })
        .catch((error) => {
          console.error("Error actualizando estado:", error);
          showToast("Error al actualizar pedido ⚠️", "#ef4444");
        });
    }
  </script>
</body>
</html>
