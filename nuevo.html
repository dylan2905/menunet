<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuevo Pedido - Menunet</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="bg-gray-950 text-white font-sans p-4">
    <header class="mb-6">
      <h1 class="text-2xl font-bold">üìù Crear Nuevo Pedido</h1>
    </header>

    <div id="resumen" class="mb-4"></div>

    <form id="formulario" class="space-y-6">
      <div>
        <label for="mesa" class="block text-sm mb-1">Selecciona Mesa</label>
        <select id="mesa" required class="w-full p-2 bg-gray-800 text-white rounded">
          <option value="">-- Selecciona --</option>
          <option value="1">Mesa 1</option>
          <option value="2">Mesa 2</option>
          <option value="3">Mesa 3</option>
          <option value="4">Mesa 4</option>
          <option value="5">Mesa 5</option>
        </select>
      </div>

      <div>
        <h2 class="text-lg font-semibold mb-2">üßæ Productos</h2>
        <div id="productos-lista" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
      </div>

      <div>
        <h2 class="text-lg font-semibold mb-2">üõí Carrito</h2>
        <div id="carrito" class="bg-gray-900 p-4 rounded-xl space-y-2"></div>
        <p class="text-right text-green-400 font-bold text-lg mt-2">Total: <span id="total">$0</span></p>
      </div>

      <button type="submit" class="w-full bg-green-600 hover:bg-green-500 py-3 rounded text-lg font-semibold">
        Enviar Pedido
      </button>
    </form>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        push,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAumkx4CKgbJcdDcQ9eXzw8Ol5od8WMa5k",
        authDomain: "menunet-46d2c.firebaseapp.com",
        databaseURL: "https://menunet-46d2c-default-rtdb.firebaseio.com",
        projectId: "menunet-46d2c",
        storageBucket: "menunet-46d2c.appspot.com",
        messagingSenderId: "27587490373",
        appId: "1:27587490373:web:34b2afbb1ea3a341fa292c",
        measurementId: "G-6N4ZSXGZ56",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      const productosRef = ref(db, "productos");
      const lista = document.getElementById("productos-lista");
      const carritoContainer = document.getElementById("carrito");
      const totalSpan = document.getElementById("total");
      const resumen = document.getElementById("resumen");
      const formulario = document.getElementById("formulario");
      const mesaSelect = document.getElementById("mesa");

      let carrito = [];

      // Cargar productos desde Firebase
      onValue(productosRef, (snapshot) => {
        const data = snapshot.val();
        lista.innerHTML = "";
        if (!data) return;

        for (let id in data) {
          const p = data[id];
          const card = document.createElement("div");
          card.className =
            "bg-gray-800 p-4 rounded-xl shadow text-center flex flex-col items-center";

          card.innerHTML = `
            <img src="${p.imagen || "https://via.placeholder.com/100"}" alt="${p.nombre}" class="w-20 h-20 object-cover rounded-full mb-2">
            <h3 class="font-semibold">${p.nombre}</h3>
            <p class="text-sm text-gray-400 mb-2">$${p.precio}</p>
            <button class="agregar bg-green-600 px-3 py-1 rounded text-sm hover:bg-green-500">Agregar</button>
          `;

          card.querySelector(".agregar").addEventListener("click", () => {
            const existente = carrito.find((item) => item.id === id);
            if (existente) {
              existente.cantidad++;
            } else {
              carrito.push({ id, nombre: p.nombre, precio: p.precio, cantidad: 1 });
            }
            renderCarrito();
          });

          lista.appendChild(card);
        }
      });

      function renderCarrito() {
        carritoContainer.innerHTML = "";
        let total = 0;

        carrito.forEach((p, i) => {
          total += p.precio * p.cantidad;

          const item = document.createElement("div");
          item.className = "flex justify-between items-center border-b border-gray-700 py-2";

          const nombreSpan = document.createElement("span");
          nombreSpan.textContent = `${p.nombre} x${p.cantidad}`;

          const controlDiv = document.createElement("div");
          controlDiv.className = "flex gap-2 items-center";

          const btnMenos = document.createElement("button");
          btnMenos.className = "text-sm text-white bg-gray-700 px-2 rounded";
          btnMenos.textContent = "-";
          btnMenos.addEventListener("click", () => modificar(i, -1));

          const btnMas = document.createElement("button");
          btnMas.className = "text-sm text-white bg-gray-700 px-2 rounded";
          btnMas.textContent = "+";
          btnMas.addEventListener("click", () => modificar(i, 1));

          const precioSpan = document.createElement("span");
          precioSpan.className = "text-green-400";
          precioSpan.textContent = "$" + (p.precio * p.cantidad).toLocaleString();

          controlDiv.appendChild(btnMenos);
          controlDiv.appendChild(btnMas);
          controlDiv.appendChild(precioSpan);

          item.appendChild(nombreSpan);
          item.appendChild(controlDiv);

          carritoContainer.appendChild(item);
        });

        totalSpan.textContent = "$" + total.toLocaleString();
      }

      function modificar(i, delta) {
        carrito[i].cantidad += delta;
        if (carrito[i].cantidad <= 0) carrito.splice(i, 1);
        renderCarrito();
      }

      formulario.addEventListener("submit", (e) => {
        e.preventDefault();
        if (carrito.length === 0) return alert("Agrega productos al pedido.");
        const mesa = mesaSelect.value;
        if (!mesa) return alert("Selecciona una mesa.");

        const total = carrito.reduce((sum, p) => sum + p.precio * p.cantidad, 0);
        const pedido = {
          mesa,
          estado: "En preparaci√≥n",
          productos: carrito,
          total,
          timestamp: Date.now(),
        };

        const pedidosRef = ref(db, "pedidos");
        const nuevoRef = push(pedidosRef);
        set(nuevoRef, pedido).then(() => {
          formulario.classList.add("hidden");
          resumen.innerHTML = `
            <div class="bg-gray-900 p-6 rounded-xl shadow text-center">
              <h2 class="text-xl font-bold mb-2">‚úÖ Pedido enviado</h2>
              <p class="text-green-400 font-semibold mb-2">Mesa ${mesa}</p>
              <p>Total: <strong>$${total.toLocaleString()}</strong></p>
              <button id="nuevoPedidoBtn" class="mt-4 bg-blue-600 px-4 py-2 rounded hover:bg-blue-500">Nuevo Pedido</button>
            </div>
          `;

          document.getElementById("nuevoPedidoBtn").addEventListener("click", () => {
            carrito = [];
            renderCarrito();
            resumen.innerHTML = "";
            formulario.classList.remove("hidden");
            formulario.reset();
          });
        });
      });
    </script>
  </body>
</html>
